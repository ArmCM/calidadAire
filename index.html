<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
  <title>Calidad del Aire</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>

  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <style type="text/css" src="gauge.css">
    			.chart-gauge
  			{
  			  width: 400px;
  			  margin: 100px auto
  			 }
  			.chart-first
  			{
  				fill: #9FBD35;
  			}
  			.chart-second
  			{
  				fill: #F2BA3A;
  			}
              .chart-third
              {
                  fill: #FB3033;
              }

  			.needle, .needle-center
  			{
  				fill: #000000;
  			}
              .text {
                  color: "#112864";
                  font-size: 16px;
              }


  			svg {
  			  font: 10px sans-serif;
  			}

        .parallax img{
          filter: contrast(100%) brightness(70%);
        }


  		</style>

</head>
<body>
  <nav class="white" role="navigation">
    <div class="nav-wrapper container">
      <a id="logo-container" href="#" class="brand-logo">Logo</a>
      <ul class="right hide-on-med-and-down">
        <li><a href="#">Navbar Link</a></li>
      </ul>

      <ul id="nav-mobile" class="side-nav">
        <li><a href="#">Navbar Link</a></li>
      </ul>
      <a href="#" data-activates="nav-mobile" class="button-collapse"><i class="material-icons">menu</i></a>
    </div>
  </nav>

  <div id="index-banner" class="parallax-container">
    <div class="section no-pad-bot">
      <div class="container">

        <div class="chart-gauge"></div>
        <h1 class="header center white-text text-lighten-2 contador"></h1>
        <h1 class="header center white-text text-lighten-2">Guadalajara</h1>
        <div class="row center">
          <h5 class="header col s12 light">*Concentraciones de PM10 medidas en microgramos de partículas por metro cúbico de aire (µg/m3) <br />Fuente: Plataforma mundial para la salud y la calidad del aire de la OMS</h5>
        </div>
        <div class="row center">
          <a href="#" id="download-button" class="btn-large waves-effect waves-light teal lighten-1">Actúa</a>
        </div>
        <br><br>

      </div>
    </div>
    <div class="parallax"><img src="background1.jpg" alt="Unsplashed background img 1"></div>
  </div>


  <div class="container">
    <div class="section">

      <!--   Icon Section   -->
      <div class="row">
        <div class="col s12 m4">
          <div class="icon-block">
            <h2 class="center brown-text"><i class="material-icons">flash_on</i></h2>
            <h5 class="center">PM10, SO, O3</h5>
            <h5 class="center">Contaminantes</h5>

          </div>
        </div>

        <div class="col s12 m4">
          <div class="icon-block">
            <h2 class="center brown-text"><i class="material-icons">group</i></h2>
            <h5 class="center">255</h5>
            <h5 class="center">Muertes anuales causadas por contaminación en el aire</h5>
          </div>
        </div>

        <div class="col s12 m4">
          <div class="icon-block">
            <h2 class="center brown-text"><i class="material-icons">settings</i></h2>
            <h5 class="center">20</h5>
            <h5 class="center">Nivel de contaminación en México</h5>
          </div>
        </div>
      </div>

    </div>
  </div>


  <div class="parallax-container valign-wrapper">
    <div class="section no-pad-bot">
      <div class="container">
        <div class="row center">
          <h5 class="header col s12 light">Ayuda a mantener un mejor nivel de calidad en el aire.</h5>
        </div>
        <div class="row center">
          <a href="#" id="download-button" class="btn-large waves-effect waves-light teal lighten-1">Actúa</a>
        </div>
      </div>
    </div>
    <div class="parallax"><img src="background2.jpg" alt="Unsplashed background img 2"></div>
  </div>

  <!-- <div class="container">
    <div class="section">

      <div class="row">
        <div class="col s12 center">
          <h3><i class="mdi-content-send brown-text"></i></h3>
          <h4>Contact Us</h4>
          <p class="left-align light">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam scelerisque id nunc nec volutpat. Etiam pellentesque tristique arcu, non consequat magna fermentum ac. Cras ut ultricies eros. Maecenas eros justo, ullamcorper a sapien id, viverra ultrices eros. Morbi sem neque, posuere et pretium eget, bibendum sollicitudin lacus. Aliquam eleifend sollicitudin diam, eu mattis nisl maximus sed. Nulla imperdiet semper molestie. Morbi massa odio, condimentum sed ipsum ac, gravida ultrices erat. Nullam eget dignissim mauris, non tristique erat. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae;</p>
        </div>
      </div>

    </div>
  </div> -->


  <!-- <div class="parallax-container valign-wrapper">
    <div class="section no-pad-bot">
      <div class="container">
        <div class="row center">
          <h5 class="header col s12 light">A modern responsive front-end framework based on Material Design</h5>
        </div>
      </div>
    </div>
    <div class="parallax"><img src="background3.jpg" alt="Unsplashed background img 3"></div>
  </div> -->

  <footer class="page-footer teal">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5 class="white-text">Calidad del aire</h5>
          <p class="grey-text text-lighten-4">We are a team of college students working on this project like it's our full time job. Any amount would help support and continue development on this project and is greatly appreciated.</p>


        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Ayuda</h5>
          <ul>
            <li><a class="white-text" href="#!">Link 1</a></li>
            <li><a class="white-text" href="#!">Link 2</a></li>
            <li><a class="white-text" href="#!">Link 3</a></li>
          </ul>
        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Soporte</h5>
          <p class="grey-text text-lighten-4">ort and continue development on this project and is greatly appreciated.</p>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      Hecho con <a class="brown-text text-lighten-3" href="#">Datos MX</a>
      </div>
    </div>
  </footer>


  <!--  Scripts-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.js"></script>
  <script src="js/init.js"></script>
  <script type="text/javascript" src="./gaugeClient.js"></script>
		<script type="text/javascript" src="./labels.js"></script>
        <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script type="text/javascript">
        var estaciones = [];
        var temporale = [];
        var avg = 0;
        var totalt = 0;

        $.ajax({
          type: 'GET',
          url: "http://api.datos.gob.mx/v1/calidadAire",
          data: {'stations.id':'AGU'},
          success: function( data, textStatus, jqxhr ) {

            console.log('DATA');
            console.log(data.results);

            for (var i = 0; i < data.results.length; i++) {

              //estaciones.push(data.results.stations[i].id);
              if(data.results[i].stations[0].id != "cve"){
                var contaminante = data.results[i].stations[0].measurements[0].pollutant;

                  if (contaminante == 'PM10'){
                    estaciones.push(parseFloat(data.results[i].stations[0].measurements[0].value));
                  }

                // console.log('----datos----');
                // console.log(data.results[i].stations[0].measurements[0].pollutant);
              }

            }
            for(var k = 0 ; k < estaciones.length; k++) {
                totalt += estaciones[k];
            }
            console.log('Total');
            console.log(totalt);
            console.log(estaciones.length);
            avg = totalt / estaciones.length;
            console.log(avg);

            $('.contador').html(avg.toFixed(2));

          },
          xhrFields: {
            withCredentials: false
          },
          crossDomain: true,
          async:false
        });


var name = "Calidad del Aire";

var value = avg;


var gaugeMaxValue = 100;

// données à calculer
var percentValue = value / gaugeMaxValue;

////////////////////////

var needleClient;



(function(){

var barWidth, chart, chartInset, degToRad, repaintGauge,
height, margin, numSections, padRad, percToDeg, percToRad,
percent, radius, sectionIndx, svg, totalPercent, width,
valueText, formatValue, k;

percent = percentValue;

numSections = 1;
sectionPerc = 1 / numSections / 2;
padRad = 0.025;
chartInset = 10;

// Orientation of gauge:
totalPercent = .75;

el = d3.select('.chart-gauge');

margin = {
top: 30,
right: 30,
bottom: 30,
left: 30
};

width = el[0][0].offsetWidth - margin.left - margin.right;
height = width;
radius = Math.min(width, height) / 2;
barWidth = 40 * width / 300;



//Utility methods

percToDeg = function(perc) {
return perc * 360;
};

percToRad = function(perc) {
return degToRad(percToDeg(perc));
};

degToRad = function(deg) {
return deg * Math.PI / 180;
};

// Create SVG element
//svg = el.append('svg').attr('width', width + margin.left + margin.right).attr('height', height + margin.top + margin.bottom);
svg = el.append('svg').attr('width', width + margin.left + margin.right).attr('height', '220');

// Add layer for the panel
chart = svg.append('g').attr('transform', "translate(" + ((width) / 2 + margin.left) + ", " + ((height + margin.top) / 2) + ")");


chart.append('path').attr('class', "arc chart-first");
chart.append('path').attr('class', "arc chart-second");
chart.append('path').attr('class', "arc chart-third");
chart.append('path').attr('class', "arc chart-fourth");
chart.append('path').attr('class', "arc chart-fifth");

valueText = chart.append("text")
                .attr('id', "Value")
                .attr("font-size",16)
                .attr("text-anchor","middle")
                .attr("dy",".5em")
                .style("fill", '#000000');
//formatValue = d3.format('1%');
formatValue = d3.format(".2f");

arc5 = d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth)
arc4 = d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth)
arc3 = d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth)
arc2 = d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth)
arc1 = d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth)

repaintGauge = function ()
{
perc = 0.5;
var next_start = totalPercent;
arcStartRad = percToRad(next_start);
arcEndRad = arcStartRad + percToRad(perc / 5);
next_start += perc / 5;


arc1.startAngle(arcStartRad).endAngle(arcEndRad);

arcStartRad = percToRad(next_start);
arcEndRad = arcStartRad + percToRad(perc / 5);
next_start += perc / 5;

arc2.startAngle(arcStartRad + padRad).endAngle(arcEndRad);

arcStartRad = percToRad(next_start);
arcEndRad = arcStartRad + percToRad(perc / 5);
next_start += perc / 5;

arc3.startAngle(arcStartRad + padRad).endAngle(arcEndRad);

arcStartRad = percToRad(next_start);
arcEndRad = arcStartRad + percToRad(perc / 5);
next_start += perc / 5;

arc4.startAngle(arcStartRad + padRad).endAngle(arcEndRad);

arcStartRad = percToRad(next_start);
arcEndRad = arcStartRad + percToRad(perc / 5);

arc5.startAngle(arcStartRad + padRad).endAngle(arcEndRad);

chart.select(".chart-first").attr('d', arc1);
chart.select(".chart-second").attr('d', arc2);
chart.select(".chart-third").attr('d', arc3);
chart.select(".chart-fourth").attr('d', arc4);
chart.select(".chart-fifth").attr('d', arc5);

}
/////////

var dataset = [{metric:name, value: value}]

var texts = svg.selectAll("text")
            .data(dataset)
            .enter();

texts.append("text")
     .text(function(){
          return dataset[0].metric;
     })
     .attr('id', "Name")
     .attr('transform', "translate(" + ((width + margin.left) / 6) + ", " + ((height + margin.top) / 1.5) + ")")
     .attr("font-size",25)
     .style("fill", "#000000");


texts.append("text")
    .text(function(){
        return 0;
    })
    .attr('id', 'scale0')
    .attr('transform', "translate(" + ((width + margin.left) / 100 ) + ", " + ((height + margin.top) / 2) + ")")
    .attr("font-size", 15)
    .style("fill", "#000000");

texts.append("text")
    .text(function(){
        return gaugeMaxValue/2;
    })
    .attr('id', 'scale10')
    .attr('transform', "translate(" + ((width + margin.left) / 2.15 ) + ", " + ((height + margin.top) / 30) + ")")
    .attr("font-size", 15)
    .style("fill", "#000000");


texts.append("text")
    .text(function(){
        return gaugeMaxValue;
    })
    .attr('id', 'scale20')
    .attr('transform', "translate(" + ((width + margin.left) / 1.03 ) + ", " + ((height + margin.top) / 2) + ")")
    .attr("font-size", 15)
    .style("fill", "#000000");

var Needle = (function() {

//Helper function that returns the `d` value for moving the needle
var recalcPointerPos = function(perc) {
  var centerX, centerY, leftX, leftY, rightX, rightY, thetaRad, topX, topY;
  thetaRad = percToRad(perc / 2);
  centerX = 0;
  centerY = 0;
  topX = centerX - this.len * Math.cos(thetaRad);
  topY = centerY - this.len * Math.sin(thetaRad);
  leftX = centerX - this.radius * Math.cos(thetaRad - Math.PI / 2);
  leftY = centerY - this.radius * Math.sin(thetaRad - Math.PI / 2);
  rightX = centerX - this.radius * Math.cos(thetaRad + Math.PI / 2);
  rightY = centerY - this.radius * Math.sin(thetaRad + Math.PI / 2);


    return "M " + leftX + " " + leftY + " L " + topX + " " + topY + " L " + rightX + " " + rightY;




};

function Needle(el) {
  this.el = el;
  this.len = width / 2.5;
  this.radius = this.len / 8;
}

Needle.prototype.render = function() {
  this.el.append('circle').attr('class', 'needle-center').attr('cx', 0).attr('cy', 0).attr('r', this.radius);




  return this.el.append('path').attr('class', 'needle').attr('id', 'client-needle').attr('d', recalcPointerPos.call(this, 0));


};

Needle.prototype.moveTo = function(perc) {
  var self,
      oldValue = this.perc || 0;

  this.perc = perc;
  self = this;

  // Reset pointer position
  this.el.transition().delay(100).ease('quad').duration(200).select('.needle').tween('reset-progress', function() {
    return function(percentOfPercent) {
      var progress = (1 - percentOfPercent) * oldValue;




      repaintGauge(progress);
      return d3.select(this).attr('d', recalcPointerPos.call(self, progress));
    };
  });

  this.el.transition().delay(300).ease('bounce').duration(1500).select('.needle').tween('progress', function() {
    return function(percentOfPercent) {
      var progress = percentOfPercent * perc;
      //var progress = perc;

      repaintGauge(progress);

      var thetaRad = percToRad(progress / 2);
      var textX = - (self.len + 45) * Math.cos(thetaRad);
      var textY = - (self.len + 45) * Math.sin(thetaRad);

      valueText.text(formatValue(progress))
        .attr('transform', "translate("+textX+","+textY+")")

      return d3.select(this).attr('d', recalcPointerPos.call(self, progress));
    };
  });

};


return Needle;

})();



needle = new Needle(chart);
needle.render();
needle.moveTo(percent);

setTimeout(displayValue, 1350);



})();
        </script>

  </body>
</html>
