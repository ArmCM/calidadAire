<!DOCTYPE html>
<html lang="en">
<head>
  <title>Calidad del Aire</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

  <link rel="import" href="bower_components/polymer/polymer.html">
  <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>

  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

  <link rel="stylesheet" href="http://cdn.datos.gob.mx/qa/bower_components/dgm-style/main.css" />

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="import" href="https://cdn.datos.gob.mx/bower_components/dgm-navbar/dgm-navbar.html">
  <link rel="import" href="https://cdn.datos.gob.mx/bower_components/dgm-footer/dgm-footer.html">
  
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
  integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
  crossorigin=""/>
  <!-- Fuente Roboto-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,700" rel="stylesheet">
  <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Tangerine">



</head>
<body class="front" cz-shortcut-listen="true" >

  <dgm-navbar></dgm-navbar>
  <main>
    <div id="" class="cabezera" style="background-image: url('imagenes/fondo.jpg');background-size: cover; background-repeat: no-repeat;background-position:center top; height: 100vh; width: 100vw;">
      <div class="section no-pad-bot">
        <div class="container" style="padding-top: 30%;">
          <div class="row">
            <div class="col-xs-12 text-center">
              <h2 style="color: #FFFFFF">Calidad de Aire MX</h2>
            </div>
          </div>

          <div class="row">
            <div class="col-xs-12 text-center margen_arriba_g">
              <div class="base_botones">
                <select class="browser-default contaminantes_mitad" name="" onchange="ponEstacionesSel()" id="estado_primer_select"></select>
                <select class="browser-default contaminantes_mitad" name="" id="estaciones_select"></select>
                <br>
                <select class="browser-default" name="" id="contaminantes">
                  <option value="0">Contaminate</option>
                  <option value="PM10_24">PM 10 µg/m&sup3;</option>
                  <option value="PM2.5_24">PM 2.5 µg/m&sup3;</option>
                  <option value="SO2_24">SO2 (ppm) Promedio 24 horas</option>
                  <option value="SO2_8">SO2 (ppm) Promedio 8 horas</option>
                  <option value="SO2_D">SO2 (ppm) Dato horario</option>
                  <option value="O3_8">Ozono (O3)(ppm) Promedio 8 horas</option>
                  <option value="O3_D">Ozono (O3)(ppm) Dato horario</option>
                  <option value="NO2_24">NO2 (ppm)</option>
                  <option value="CO_24">CO (ppm)</option>
                </select>
              </div> 
            </div>         
            <div class="col-xs-12 text-center">
              <h5 class="white-text"><span id="contaminante_titulo">Preguntas frecuentes | Glosario</span></h5>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row mapa_titulo">
        <div class="col  col-xs-12">
          <h3 class="titulo_mapa">Estaciones de medición de contaminantes</h3>
        </div>
        <div class="col col-xs-12 ">
          <div class="input-field col s6 m2 l2">
            <select  name="estados" id="estados" class="browser-default ">
              <option value="Aguascalientes">Aguascalientes</option>
              <option value="Baja California">Baja California</option>
              <option value="Baja California Sur">Baja California Sur</option>
              <option value="Campeche">Campeche</option>
              <option value="Chiapas">Chiapas</option>
              <option value="Chihuahua">Chihuahua</option>
              <option value="Ciudad de México">Ciudad de México</option>
              <option value="Coahuila de Zaragoza2">Coahuila de Zaragoza2</option>
              <option value="Colima">Colima</option>
              <option value="Durango">Durango</option>
              <option value="Guanajuato">Guanajuato</option>
              <option value="Guerrero">Guerrero</option>
              <option value="Hidalgo">Hidalgo</option>
              <option value="Jalisco">Jalisco</option>
              <option value="México">México</option>
              <option value="Michoacán de Ocampo">Michoacán de Ocampo</option>
              <option value="Morelos">Morelos</option>
              <option value="Nayarit">Nayarit</option>
              <option value="Nuevo León">Nuevo León</option>
              <option value="Oaxaca">Oaxaca</option>
              <option value="Puebla">Puebla</option>
              <option value="Querétaro de Arteaga">Querétaro de Arteaga</option>
              <option value="Quintana Roo">Quintana Roo</option>
              <option value="San Luis Potosí">San Luis Potosí</option>
              <option value="Sinaloa">Sinaloa</option>
              <option value="Sonora">Sonora</option>
              <option value="Tabasco">Tabasco</option>
              <option value="Tamaulipas">Tamaulipas</option>
              <option value="Tlaxcala">Tlaxcala</option>
              <option value="Veracruz de Ignacio de la Llave">Veracruz de Ignacio de la Llave</option>
              <option value="Yucatán">Yucatán</option>
              <option value="Zacatecas">Zacatecas</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col col-xs-12">
        <div id="mapid"></div>
      </div>
    </div>

    <div class="row">
      <div class="col col-xs-12">
        <h2> <a href="//datos.gob.mx/busca" target="_self">Datos</a></h2>
        <hr class="red">
      </div>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <p class="titulo"><strong id="titulo_detalle">Ciudad Fernández</strong></p>
          </div>
          <div class="modal-body">
            <!-- esto sera el modal -->
            
              <div class="row ">
                <div class="col-xs-3">
                  <div class="col-xs-4">
                    <img class="img-responsive" src="imagenes/fecha.png">
                  </div>
                  <div class="col-xs-8">
                    <p><b >Fecha</b></p>
                    <p id="fecha_detalle">24/05/17</p>
                  </div>
              
                  <div class="col-xs-4">
                    <img class="img-responsive" src="imagenes/estacion.png">
                  </div>
                  <div class="col-xs-8">
                    <p><b>Estación:</b></p>
                    <p id="estacion_detalle">XAL-Xalostoc</p>
                  </div>
                  
                  <div class="col-xs-4">
                    <img class="img-responsive" src="imagenes/temperatura.png">
                  </div>
                  <div class="col-xs-8">
                    <p><b >Temperatura</b></p>
                    <p id="temperatura_detalle">24/05/17</p>
                  </div>

                  <div class="col-xs-4">
                    <img class="img-responsive" src="imagenes/contaminante.png">
                  </div>
                  <div class="col-xs-8">
                    <p><b >Contaminante:</b></p>
                    <p id="contaminante_detalle">PM10, 104</p>
                  </div>
                  
                </div>
                <div class="col-xs-9">
                    <div class="col-xs-12">
                        <p class="titulo"><strong>Valores maximos registrsdos del contaminate <span id="contaminante_grafica"> XXX </span></strong></p>
                    </div>
                    <div class="row margenes_pop">
                      <div class="row">
                        <div class="col-xs-4">

                          <p class="active_pop boton_pop" id="botonPM10" onclick="cambioParametro('PM10',24,'botonPM10')">PM10 (µg/m&sup3;) 24 horas</p>
                        </div>
                        <div class="col-xs-4">
                          <p class="boton_pop" id="botonPM25" onclick="cambioParametro('PM2.5',24,'botonPM25')">PM2.5 (µg/m&sup3;) 24 horas</p>
                        </div>
                        <div class="col-xs-4">
                          <p class="boton_pop" id="botonNO2" onclick="cambioParametro('NO2','D','botonNO2')">NO2 (ppm) Dato horario</p>
                        </div>
                      </div>
                      <div class="row">
                        <div class=" col-xs-4">


                          <p class="boton_pop" id="botonSO2D" onclick="cambioParametro('SO2','D','botonSO2D')">SO2 (ppm) Dato horario</p>
                        </div>
                        <div class="col-xs-4">
                          <p class="boton_pop" id="botonSO28" onclick="cambioParametro('SO2',8,'botonSO28')">SO2 (ppm) 8 horas</p>
                        </div>
                        <div class="col-xs-4">
                          <p class="boton_pop" id="botonSO224" onclick="cambioParametro('SO2',24,'botonSO224')">SO2 (ppm) 24 horas</p>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-xs-4">

                          <p class="boton_pop" id="botonO3D" onclick="cambioParametro('O3','D','botonO3D')">O3 (ppm) Dato horario</p>
                        </div>
                        <div class="col-xs-4">
                          <p class="boton_pop" id="botonO38" onclick="cambioParametro('O3',8,'botonO38')">O3 (ppm) 8 horas</p>
                        </div>
                        <div class="col-xs-4">
                          <p class="boton_pop" id="botonCO" onclick="cambioParametro('CO',8,'botonCO')">CO (ppm) 8 horas</p>
                        </div>
                      </div>
                    </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-xs-3">
                    <div class="chart-gauge"></div>
                </div>
                <div class="col-xs-9">
                  <div class="col-xs-12">
                    <h5>parametro</h5>
                    <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Molestias, delectus voluptate error libero, repudiandae </p>
                  </div>   
                  <div class="col-xs-12">
                  <h5>recomendaciones</h5>
                  <p>facere sequi odio doloremque deleniti eveniet dolores dolorum rerum nostrum similique ullam et dignissimos assumenda corporis.</p>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-xs-12 offset-m1 offset-l2">
                  <canvas id="myChart"></canvas>
                </div>
                <div class="col-xs-12 botonera">
                  <a href="#" class="parametro">boton 1</a>
                  <a href="#" class="parametro">boton 1</a>
                  <a href="#" class="parametro">boton 1</a>
                  <a href="#" id="pinta_primero" class="parametro active">boton 1</a>
                </div>
                <input type="hidden" name="estacion" id="estacion_id" value="">
                <input type="hidden" name="ciudad" id="ciudad" value="">  
              </div>

          </div> <!-- fin del body  -->
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
          </div>
        
      </div>
    </div>


   


  </main>
  <dgm-footer></dgm-footer>
  
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!-- Leaflet-->
    <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"
    integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA=="
    crossorigin=""></script>

    <script type="text/javascript" src="libs/jquery.sparkline.min.js"></script>
    <script src="libs/chartjs/Chart.bundle.js"></script>
    <script src="libs/chartjs/utils.js"></script>
    <script src="js/jquery.gaugeIt.js"></script>

    <!-- local-->
    <script src="js/utileria.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/estados_mexico.js" type="text/javascript" charset="utf-8"></script>
    <!-- <script src="js/scripts.js" type="text/javascript" charset="utf-8"></script> -->
    <script src="js/script_estados.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/estaciones_json.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/mod_mapa.js" type="text/javascript" charset="utf-8"></script>
    <script>
      var dataLocal = [];
      var chart;
      var ctx;
      var color;
      var mymap = L.map('mapid').setView([16.8889,-100], 5);

      var valores = [];
      var etiquetas = [];

      var ant_val_arr = [];
      var ant_lab_arr = [];

      var d = new Date();
      var anio = d.getFullYear();
      var mes = meis[d.getMonth()];
      var dia = deis[d.getDate()];
     
      //catalogo de constantes de configuración
      const pageSize_estaciones = 1200;

      $(document).ready(function(){

        /* instancia del mapa*/
          mymap.panTo(new L.LatLng(24.8, -100));

          var OpenStreetMap_BlackAndWhite = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', 
          {
            maxZoom: 18,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          });

          OpenStreetMap_BlackAndWhite.addTo(mymap);
          if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)) mymap.dragging.disable();
          mymap.scrollWheelZoom.disable();
        /*fin de instancia del mapa*/


        $('#estado_primer_select').html(options_estado());
        //$('#estaciones_select').html(options_estaciones());
        $('#contaminantes').change(function()
        {
          //conseguimos todas las variables necesarias para hacer la llamada a el API
          var estado =  $('#estado_primer_select').val();
          var estacion =  $('#estaciones_select').val();

          var b = $('#contaminantes').val();
          var a = b.split('_');
          var parametro = a[0];
          var horas = a[1];

          porEstaciones(estado, estacion, parametro, horas); //llamada a la estación 

          //ponemos los parametros en la ventana
          $('#fecha_detalle').html(convertDate(new Date()));
          $('#contaminante_detalle').html(parametro);
          $('#estacion_detalle').html($('#estaciones_select option:selected').text());
          
          $('#myModal').modal('show'); // mandar a llamar al modal
          

          var id;
          switch (b) {
            case 'PM10_24':   id='botonPM10'; break;
            case 'PM2.5_24':  id='botonPM25'; break;
            case 'SO2_24':    id='botonSO224'; break;
            case 'SO2_8':     id='botonSO28'; break;
            case 'SO2_D':     id='botonSO2D'; break;
            case 'O3_8':      id='botonO38'; break;
            case 'O3_D':      id='botonO3D'; break;
            case 'NO2_24':    id='botonNO2'; break;
            case 'CO_24':     id='botonCO'; break;
            default: id=''; break;
          }

          cambioBotonActivo(id);
        });

        /*instancia de la grafica*/
        ctx = document.getElementById('myChart').getContext('2d');
        color = Chart.helpers.color;
        chart = new Chart(ctx, 
        {
          type: 'line',
          data: 
          {
            labels: ["January", "February", "March", "April", "May", "June", "July"],
            datasets: 
            [
              {
                label: "Contaminantes",
                backgroundColor: color(window.chartColors.blue).alpha(0.2).rgbString(),
                borderColor: window.chartColors.blue,
                pointBackgroundColor: window.chartColors.blue,
                data: [0, 10, 5, 2, 20, 30, 45],
              }
            ]
          },
          options: 
          {
            legend: 
            {
              display: false
            },
            tooltips: {
              enabled: true
            },
            scales: {
              xAxes: [{
                ticks: {
                  autoSkip: false,
                  maxRotation: 90,
                  minRotation: 90
                }
              }]
            }
          },
        });
        // fin de instancia de la grafica
        

        $('.parametro').click(function(){
          event.preventDefault();

          $('.parametro').each(function(index){
            $( this ).removeClass('active');
          });

          $( this ).addClass('active');

          var boton = parseInt($( this ).val());
          if(ant > boton){
            var tam =  ant - boton;
            for (var i = 0; i < tam; i++) {
              ant_val_arr.push(chart.data.datasets[0].data.splice(0, 1));
              ant_lab_arr.push(chart.data.labels.splice(0, 1));
            }
          }else if(ant < boton){
            var tam = boton - ant;
            for (var i = 0; i < tam; i++) {
              chart.data.datasets[0].data.unshift(ant_val_arr.pop()[0]);
              chart.data.labels.unshift(ant_lab_arr.pop()[0]);
            }
          }

          ant = boton;
          chart.update();
        });

        //ponemos todas las estaciones en el mapa 
        //validar para que es por que no entiendo bien que show
        get_estaciones();

      }); // fin de document ready



      function cambioBotonActivo(id)
      {
        //cambio de active boton
        $(".boton_pop").each(function()
        {
          $(this).removeClass( "active_pop" )
        });  
        $('#'+id).addClass('active_pop');
      }

      function cambioParametro(parametro, horas,id)
      {
        cambioBotonActivo(id);
        var estado =  $('#estado_primer_select').val();
        var estacion =  $('#estaciones_select').val();

        $('#contaminante_detalle').html(parametro);
        porEstaciones(estado,estacion,parametro,horas);
      }

      function convertDate(inputFormat) 
      {
        function pad(s) { return (s < 10) ? '0' + s : s; }
        var d = new Date(inputFormat);
        return [pad(d.getDate()), pad(d.getMonth()+1), d.getFullYear()].join('/');
      }

      function options_estado()
      {
        var options  = '<option value="0">Estado</option>';
        for (let index = 0; index < coor_estado.length; index++) 
        {
          const element = coor_estado[index];
          options += '<option value="'+element.estado+'">'+element.estado+'</option>'
        }

        return options;
      }

      // function options_estaciones()
      // {
      //   var options  = '<option value="0">Estaciones</option>';
      //   for (let index = 0; index < estaciones_json.length; index++) 
      //   {
      //     const element = estaciones_json[index];
      //     options += '<option value="'+element.id+'">'+element.nombre+'</option>'
      //   }

      //   return options;
      // }


      function porEstaciones(estado,id_estacion,parametro,horas)
      {
        const dActual = new Date();
        var dPasada = new Date();

        var isDatoHorario =  (horas == 'D') ? true : false;
        
        if(isDatoHorario) 
        {
          horas = 2;
        }
        
        dPasada.setHours(dActual.getHours() - horas);

        //https://api.datos.gob.mx/v1/sinaica?estacionesid=[eq:244]&pageSize=4 
        //https://api.datos.gob.mx/v1/sinaica?estacionesid=244&pageSize=1200&parametro=PM10&state=Chihuahua
        var url = 'https://api.datos.gob.mx/v1/sinaica?estacionesid='+id_estacion+'&date-insert=[range:'+getFormatDateAPI(dPasada)+'%7C'+getFormatDateAPI(dActual)+']&pageSize='+pageSize_estaciones;
      
        console.log(url);
        $.ajax({
          type: 'GET',
          url: url,
          data: {},
          success: function( data, textStatus, jqxhr ) 
          {
            var promedio = 0;
            if(isDatoHorario)//validamos si es dato horario
            {
              console.log('Dato horario');
              for (let index = data.pagination.total-1; index > 0; index--) 
              {
                if(data.results[index].parametro == parametro)
                {
                  promedio =  data.results[index].valororig;
                  break;
                }                
              }
            }
            else
            {
              //filtramos el parametro deseado
              var dataParametro = [];
              for (let index = 0; index < data.pagination.total; index++) 
              {
                if(data.results[index].parametro == parametro)
                {
                  dataParametro.push(data.results[index]);  
                }
              }

              console.log(dataParametro);
              // validamos qiue según el parametro pueda ser promediado
              if(dataParametro.length > 5) // cambiar para hacer el maximo modificable
              {
                var tam = dataParametro.length;
                var acumulado = 0;
                for (let index = 0; index < tam; index++) 
                {
                  acumulado  =  acumulado + dataParametro[index].valororig;
                }
                console.log(acumulado);
                promedio =  acumulado / tam; 
              }

              console.log(promedio);     

            }
            
            if(promedio != 0)
            {
              //temporal en lo que meto el gauge
              // $('.chart-gauge').html('<p>'+promedio+'</p>');
              var valor = promedio.toFixed(2);
              var maximo = 100;
              $('.chart-gauge').html('');
              $('.chart-gauge').gaugeIt({selector:'.chart-gauge',value:valor,gaugeMaxValue:maximo});
              
              //consideraciones 
              // tenemos datos maximos 
              // tenemos un campo llamado valoring que se debe considerar
              //tenemos que vlaidar que se tenga 75% de datos para poder hacer el promedio si no se deja como dato vacio

              //poner la grafica 
              //crear otra funcion que haga una llamada de 28 dias con los parametros de la llamada anterior 

            
              var dPasada28 = new Date();
              dPasada.setHours(dActual.getHours() - (28*24));
              var url28 = 'https://api.datos.gob.mx/v1/sinaica?estacionesid='+id_estacion+'&date-insert=[range:'+getFormatDateAPI(dPasada)+'%7C'+getFormatDateAPI(dActual)+']&pageSize='+pageSize_estaciones;

              createArrayGrafica(url28, parametro); 
            }
            else
            {
              alert('El parametro seleccionado no cuenta con lecturas');
            }
            


          },
          error: function (xhr, ajaxOptions, thrownError) 
          {
            alert(xhr.status);
            alert(thrownError);
          },
          xhrFields: {
            withCredentials: false
          },
          crossDomain: true,
          async:false
        });


      }

      function createArrayGrafica(url, parametro){
        $.ajax({
          type: 'GET',
          url: url,
          data: {},
          success: function( data, textStatus, jqxhr ) 
          {
            dataLocal =  data;
            putGrafica(parametro);
          },
          error: function (xhr, ajaxOptions, thrownError) 
          {
            alert(xhr.status);
            alert(thrownError);
          },
          xhrFields: {
            withCredentials: false
          },
          crossDomain: true,
          async:false
        });
      }

      function putGrafica(parametro){
        console.log('vamos a hacer todos los datos, tomando el dataLocal');
        console.log(dataLocal);
        var data = dataLocal;
        var maximo = 158;
              var estacionesid = $('#estacion_id').val();
              var his_estacion =  [];
              var labels_temp = [];
              var values_temp = [];
              for (var i = 0; i < data.results.length; i++) {

                if(data.results[i].parametro == parametro){
                  if(!Array.isArray(his_estacion[data.results[i].fecha])){
                    his_estacion[data.results[i].fecha] = [];
                    labels_temp.push(data.results[i].fecha);
                  }

                  //validacion desde el api para valores correctos
                  if(data.results[i].validoorig == 1){
                    his_estacion[data.results[i].fecha].push(data.results[i]);
                  }

                }

              }

              for (var i = 0; i < labels_temp.length; i++) {
                var promedio = his_estacion[labels_temp[i]].length;
                var suma = 0;
                var arreglo = his_estacion[labels_temp[i]];
                for (var j = 0; j < promedio; j++) {
                  if(arreglo[j].valororig < maximo)
                    suma += arreglo[j].valororig;
                }

                if(contaminante ==  'PM10' || contaminante == 'PM2.5')
                  values_temp.push((suma/promedio).toFixed(1));
                else
                  values_temp.push((suma/promedio).toFixed(3));
              }
              console.log(values_temp);
              
              valores = values_temp;
              var labels_temp2 = [];
              for (var i = 0; i < labels_temp.length; i++) {
                labels_temp2[i] = get_fecha_formato(labels_temp[i]);
              }
              etiquetas =  labels_temp2;
              console.log(labels_temp2);

              actualizar_grafica_detalle(valores, etiquetas);
      }

      function actualizar_grafica_detalle(valores,etiquetas)
      {
        chart.data.datasets[0].data =  valores;
        chart.data.labels =  etiquetas;
        chart.update();
        poner_botones(valores);
      }

      function poner_botones(valores)
      {
        ant = valores.length;
        var parametro =  valores.length/4
        console.log(parametro);

        $('.parametro').each(function(index){
          $( this ).text(Math.round(parametro*(index+1))+' días');
          $( this ).val(Math.round(parametro*(index+1)));
          console.log($( this ).val());
        });
      }


      function convertDate(date) 
      {
        var yyyy = date.getFullYear().toString();
        var mm = (date.getMonth()+1).toString();
        var dd  = date.getDate().toString();

        var mmChars = mm.split('');
        var ddChars = dd.split('');

        return yyyy + '-' + (mmChars[1]?mm:"0"+mmChars[0]) + '-' + (ddChars[1]?dd:"0"+ddChars[0]);
      }


      function sumarDias(fecha, dias)
      {
        fecha.setDate(fecha.getDate() + dias);
        return fecha;
      }

      function getFormatDateAPI(d)
      {
        var fecha = d.getFullYear()+'-'+ meis[d.getMonth()] +'-'+((d.getDate() < 10?'0':'') + d.getDate())      +'T'+ ( (d.getHours() < 10?'0':'') + d.getHours() ) +':'+( (d.getMinutes()<10?'0':'') + d.getMinutes() )+':00';
        return fecha;
      }

      function ponEstacionesSel()
      {
        console.log('cambio de contenido para las estaciones');
        
        var x = document.getElementById("estado_primer_select").value;
        var contenido = '';
        for (let index = 0; index < estaciones_json.length; index++) 
        {
          var element =  estaciones_json[index];
          if(element.state == x && element.activa)
          {
            contenido += '<option value="'+element.id+'">'+element.nombre+'</option>';
          }  
        }
        
        $('#estaciones_select').html(contenido);
      }
      
    </script>
  </body>
</html>
